---
title: "Postgresql"
author: "Tyler Neumann"
date: "5/1/2022"
output: html_document
---

```{r libs}
library(dbUpsert)
```

```{r rm_con}
if (exists("db_con") == TRUE){
  dbDisconnect(db_con)
  rm(db_con)
}
```

## Start Postgres Docker Container ##

First, stop and remove container if it is currently running.

```{bash stop_container}
docker ps -q --filter "name=eg_postgres" | grep -q . && docker stop eg_postgres && docker rm -fv eg_postgres
```

Then start the container.

```{bash start_container}
docker run --name eg_postgres -p 5432:5432 -e POSTGRES_PASSWORD=My1secretpassword -d postgres
```

## Open Connection to Postgres ##

The postgres Docker Container is very quick to start up, but still requires ~1 second to wait before trying to open a connection.

```{r sql_con}
Sys.sleep(1)

db_con <- dbConnect(
  RPostgres::Postgres(),
  host = "localhost",
  user = "postgres",
  password = "My1secretpassword",
  port = 5432,
  dbname = "postgres"
)

db_info <- list(
  rdbms = db_con |> class() |> as.character(),
  version = db_con |> dbVersion()
)

db_info
```

## Validate DB Interface ##

```{r write_table}
df1 <- data.frame(
  var_one = 1:10,
  var_two = rnorm(10)
)

dbWriteTable(
  conn = db_con,
  name = "test_one",
  value = df1,
  overwrite = T
)
```

```{r read_table}
dbReadTable(db_con, "test_one")
```

# Set up Test Table #

```{sql, connection = db_con}
CREATE TABLE upsert_one (
    id INT NOT NULL
        CONSTRAINT upsert_one_pkey PRIMARY KEY,
    val_a NUMERIC NOT NULL,
    val_b VARCHAR(512) NULL
);
```

```{sql, connection = db_con}
CREATE TABLE "upsert two" (
    id INT NOT NULL
        CONSTRAINT upsert_two_pkey PRIMARY KEY,
    "val a" NUMERIC NOT NULL,
    "val b" VARCHAR(512) NULL
);
```

```{r}
test_one <- df1
names(test_one) <- c("id", "val_a")
dbAppendTable(db_con, "upsert_one", test_one)

test_two <- df1
names(test_two) <- c("id", "val a")
dbAppendTable(db_con, "upsert two", test_two)
```

